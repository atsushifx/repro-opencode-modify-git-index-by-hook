#!/usr/bin/env bash
# This hook is intentionally minimal.
# It only calls scripts/repro.sh to reproduce
# git index modification during prepare-commit-msg.
set -euo pipefail

# ============================================================
# Experimental guard
# ============================================================

# Only execute when explicitly enabled
if [[ "${REPRO_HOOK_ENABLED:-0}" != "1" ]]; then
  exit 0
fi

# Git hook arguments
# $1 = commit message file
# $2 = commit source
# $3 = commit SHA (if amend)
COMMIT_MSG_FILE="$1"

echo "[repro] prepare-commit-msg hook activated" >&2
echo "[repro] commit msg file: $COMMIT_MSG_FILE" >&2

# ============================================================
# Call repro script
# ============================================================

REPO_ROOT="$(git rev-parse --show-toplevel)"
REPRO_SCRIPT="$REPO_ROOT/scripts/repro.sh"

if [[ ! -x "$REPRO_SCRIPT" ]]; then
  echo "[repro] ERROR: repro script not found or not executable" >&2
  exit 1
fi

"$REPRO_SCRIPT"

# ============================================================
# Detect index mutation and abort if needed
# ============================================================

if ! git diff --cached --quiet; then
  echo "[repro] ERROR: index was modified during prepare-commit-msg" >&2
  echo "[repro] aborting commit to preserve user intent" >&2
  exit 1
fi

exit 0

